<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><title>微服务系统中故障种类及处理手段 | SEINA BLOG</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="John Doe"><meta name="designer" content="minfive"><meta name="keywords" content="undefined"><meta name="description" content="个人博客，主要记录笔者在程序媛道路上的技术成长和思想沉淀，也会涉及一些开源技术官方文档翻译～由于博客刚刚搭建几天，评论等个别功能尚未集成，敬请谅解，笔者有时间一定会尽快完善～"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="http://seina.top/2018/11/16/faultHandling/index.html"><link rel="icon" type="image/png" href="/img/favicon_ico.ico" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="SEINA"><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart=""><div id="page-loading" class="page page-loading" style="background-image:url(http://oo12ugek5.bkt.clouddn.com/blog/images/loader.gif)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="SEINA" alt="SEINA"><img src="/img/21541748561pic.png" alt="SEINA"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li><li class="nav__item"><a href="/about" alt="关于" title="关于">关于</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><header class="post__info"><h1 class="post__title">微服务系统中故障种类及处理手段</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="https://seina.top">seina</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2018-11-16 16:04:51</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/微服务架构/">微服务架构</a></li><li class="mark__item"><a href="/tags/分布式系统/">分布式系统</a></li></ul></div></div></header><div class="post__content"><h3 id="一、常见三种故障："><a href="#一、常见三种故障：" class="headerlink" title="一、常见三种故障："></a>一、常见三种故障：</h3><blockquote><ul><li>单机故障：集群中的个别机器出现故障，导致调用到故障机器的请求都失败</li><li>集群故障：因为微服务系统一般都是集群部署的，根据业务量的大小而定，集群规模从几台到上万台都有可能。一旦某些代码出现bug可能整个集群都会发生故障，导致不能对外提供服务</li><li>单IDC故障：某个IDC的光缆因为道路施工被挖断，导致整个IDC脱网</li></ul></blockquote><h3 id="二、集群故障处理-—-限流和降级"><a href="#二、集群故障处理-—-限流和降级" class="headerlink" title="二、集群故障处理 — 限流和降级"></a>二、集群故障处理 — 限流和降级</h3><h5 id="产生的原因主要有两种"><a href="#产生的原因主要有两种" class="headerlink" title="产生的原因主要有两种"></a>产生的原因主要有两种</h5><blockquote><ol><li>代码bug所致，比如某一段Java代码不断地分配大对象，但没有及时回收导致JVM OOM退出</li><li>突发的流量冲击，超出了系统的最大承载能力，比如双11，零点一瞬间涌入大量流量</li></ol></blockquote><h5 id="限流"><a href="#限流" class="headerlink" title="限流"></a>限流</h5><p>限流就是指限制流量，在实际项目中可以使用QPS即每秒请求量和工作线程数这两个指标来衡量服务的请求量，不同服务的QPS响应的快慢不同，系统能够承载的QPS相差很大，因此一般选择工作线程数来作为限流的指标.给系统设置一个总的最大工作线程数以及单个服务的最大工作线程数，这样的话，无论系统的总请求量过大导致整体工作线程数量达到最大工作线程数，还是个别服务的请求量超过单个服务的最大工作线程数，都会被限流，以起到保护整个系统的作用。</p><p>系统能够承载的流量根据集群规模的大小是固定的，可以称之为整个系统的最大容量，当真实流量超过了系统的最大流量后，就会导致系统响应变慢，服务调用出现大量超时，反映给用户的感觉就是卡顿、无响应。</p><p>除此之外，通常一个微服务系统中会同时提供多个服务，每个服务在同一时刻的请求量也是不同，如果系统中某个服务的请求量突增，占用了系统中大部分资源，导致其他服务没有资源可用。</p><h5 id="解决办法："><a href="#解决办法：" class="headerlink" title="解决办法："></a>解决办法：</h5><blockquote><ol><li>根据系统的最大容量，给系统设置一个阈值，超过这个阈值的请求会自动抛弃，这样的化才可以最大限度地保证系统提供的服务正常。</li><li>针对系统中的每个服务的请求量也设置一个阈值，超过这个阈值的请求也要被自动放弃，这样也不至于一个服务影响了其他所有的服务</li></ol></blockquote><h5 id="降级"><a href="#降级" class="headerlink" title="降级"></a>降级</h5><p>降级就是通过停止系统中的某些功能，来保护系统的整体可用性，是一种被动防御的措施，一般是在系统出现故障后所采取的一种止损措施。比如我的笔记本同时接两个显示屏和电源，最近异常的很热，为了保证电脑不会热的爆炸，为了保证电脑的高可用性，我可以把电源降级，直接拔掉电源，或者拔掉一个显示屏等。</p><h6 id="降级的分类："><a href="#降级的分类：" class="headerlink" title="降级的分类："></a>降级的分类：</h6><blockquote><ul><li>一级降级：一级降级是对业务影响最小的降级，在故障的情况下，首先执行一级降级，所以一级降级也可以设置成自动降级，不需要人为干预</li><li>二级降级：二级降级是对业务有一定影响的降级，在故障的情况下，如果一级降级起不到多大作用的时候，可以人为采取措施，执行二级降级</li><li>三级降级：三级降级是对业务有较大影响的降级，这种降级要么是对商业收入有重大影响，要么是对用户体验有重大影响，所以操作起来要非常谨慎，不在最后时刻一般不予采用。</li></ul></blockquote><p>降级的一般通过开关来实现。具体来讲，在系统运行的内存中开辟出一块区域，专门用于存储开关的状态，并且需要监听某个端口，通过这个端口可以向系统下发命令，来改变内存中开关的状态。</p><h6 id="开关一般用在两种地方："><a href="#开关一般用在两种地方：" class="headerlink" title="开关一般用在两种地方："></a>开关一般用在两种地方：</h6><blockquote><ol><li>新增的业务逻辑：新增的业务逻辑相对来说不成熟，往往具备一定的风险，所以需要加开关来控制新业务逻辑是否执行</li><li>依赖的服务或资源：因为依赖的服务或者资源不总是可靠的，所以最好是有开关能够控制是否对依赖服务或资源发起调用，来保证即使依赖出现问题，也能通过降级来避免影响</li></ol></blockquote><h3 id="单IDC故障"><a href="#单IDC故障" class="headerlink" title="单IDC故障"></a>单IDC故障</h3><p>在现实情况下，整个IDC脱网的事情时有发生，比如机房着火、光缆被挖断等，如果业务全部部署在这个IDC，那就完全不可访问了。国内采取多IDC部署，当一个IDC发生故障之后，可以把原来访问故障 IDC 的流量切换到正常的 IDC，来保证业务的正常访问</p><blockquote><ul><li>同城双活：一个城市的两个 IDC 内部署</li><li>异地多活：一般是在两个城市的两个 IDC 内部署</li><li>三地五中心：支付宝这种金融级别的使用，成本显然高比两个 IDC 要高得多，但可用性的保障要更高</li></ul></blockquote><h6 id="那么流量怎么切换呢，一般分为两种："><a href="#那么流量怎么切换呢，一般分为两种：" class="headerlink" title="那么流量怎么切换呢，一般分为两种："></a>那么流量怎么切换呢，一般分为两种：</h6><ol><li><p>基于 DNS 解析的流量切换: 基于 DNS 解析流量的切换，一般是通过把请求访问域名解析的 VIP 从一个 IDC 切换到另外一个 IDC。比如访问<a href="www.weibo.com">www.weibo.com</a>， 正常情况下北方用户会解析到联通机房的 VIP，南方用户会解析到电信机房的 VIP，如果联通机房发生故障的话，会把北方用户访问也解析到电信机房的 VIP，只不过此时网络延迟可能会变长。</p></li><li><p>基于 RPC 分组的流量切换: 对于一个服务来说，如果是部署在多个 IDC 的话，一般每个 IDC 就是一个分组。假如一个 IDC 出现故障，那么原先路由到这个分组的流量，就可以通过向配置中心下发命令，把原先路由到这个分组的流量全部切换到别的分组，这样的话就可以切换故障IDC的流量。</p></li></ol><h3 id="三、单机故障"><a href="#三、单机故障" class="headerlink" title="三、单机故障"></a>三、单机故障</h3><p>在上万台机器的规模中出现单机故障是很常见的，这个时候只靠运维人肉处理显然不可行，所以就要求有某种手段来自动处理单机故障。</p><p>处理单机故障一个有效的办法就是自动重启。具体来讲，你可以设置一个阈值，比如以某个接口的平均耗时为准，当监控单机上某个接口的平均耗时超过一定阈值时，就认为这台机器有问题，这个时候就需要把有问题的机器从线上集群中摘除掉，然后在重启服务后，重新加入到集群中。</p><h5 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h5><blockquote><ol><li>防止网络抖动造成的接口超时从而触发自动重：在收集单机接口耗时数据时，多采集几个点，比如每 10s 采集一个点，采集 5 个点，当 5 个点中有超过 3 个点的数据都超过设定的阈值范围，才认为是真正的单机问题，这时会触发自动重启策略。</li><li>短时间重启单机过多导致服务池可用节点太少：设置一个可重启的单机数量占整个集群的最大比例，一般这个比例不要超过 10%，因为正常情况下，不大可能有超过 10% 的单机都出现故障。</li></ol></blockquote><h3 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h3><p>微服务可能出现的三种故障：集群故障，单机故障，单IDC故障，以及响应的解决方案：降级，限流，流量切换以及自动重启。在遇到实际故障时，往往多个手段是并用的，比如出现单IDC故障，首先要快速切换到正常的IDC，但此时可能正常的IDC并不足以支撑两个IDC的流量，所以要降级部分功能，保证正常的IDC顺利的支撑切换过来的流量。</p><p>而且尽量让故障处理自动化，这样可以大大减少故障影响的时间。因为一旦需要引入人为干预，往往故障处理的时间都得是10分钟以上，这对大部分用户敏感型业务的影响是巨大的，如果能做到自动化处理，可以将故障处理的时间降低到 1 分钟以内甚至秒级别，这样的话对于用户的影响最小。</p><div class="post-announce">感谢您的阅读，本文由 <a href="http://seina.top">SEINA</a> 版权所有。如若转载，请注明出处：SEINA（<a href="http://seina.top/2018/11/16/faultHandling/">http://seina.top/2018/11/16/faultHandling/</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/2018/11/11/microservice/" title="如何快速的理解什么是微服务？"><i class="iconfont icon-prev"></i>如何快速的理解什么是微服务？</a></div><div class="post__prev post__prev--right"><a href="/2018/11/26/proxy/" title="简而易懂的代理模式">简而易懂的代理模式<i class="iconfont icon-next"></i></a></div></div></div></article></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">简介</h3><p class="block__text">个人博客，主要记录笔者在程序媛道路上的技术成长和思想沉淀，也会涉及一些开源技术官方文档翻译～由于博客刚刚搭建几天，评论等个别功能尚未集成，敬请谅解，笔者有时间一定会尽快完善～</p></div><div class="sidebar__block"><h3 class="block__title">文章分类</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/极客时间学习/">极客时间学习</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/数据结构和算法/">数据结构和算法</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/大战设计模式/">大战设计模式</a><span class="block-list-count">6</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/初识微服务/">初识微服务</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Activiti工作流/">Activiti工作流</a><span class="block-list-count">1</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2019/01/17/activitiWebH2ToMysql/" title="记录一次Activiti在线Web流程设计器从h2数据库转成mysql线上故障排查"><div class="item__info"><h3 class="item__title">记录一次Activiti在线Web流程设计器从h2数据库转成mysql线上故障排查</h3><span class="item__text">2019-01-17 20:56:16</span></div></a></li><li class="latest-post-item"><a href="/2019/01/14/linkedListCycle/" title="链表 - 判断一个链表是否有环以及求出环入口点"><div class="item__info"><h3 class="item__title">链表 - 判断一个链表是否有环以及求出环入口点</h3><span class="item__text">2019-01-14 23:18:00</span></div></a></li><li class="latest-post-item"><a href="/2019/01/02/geekTime/" title="极客时间海报礼券分享"><div class="item__info"><h3 class="item__title">极客时间海报礼券分享</h3><span class="item__text">2019-01-02 19:58:35</span></div></a></li><li class="latest-post-item"><a href="/2018/11/26/proxy/" title="简而易懂的代理模式"><div class="item__info"><h3 class="item__title">简而易懂的代理模式</h3><span class="item__text">2018-11-26 21:39:25</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Activiti/">Activiti</a></li><li class="tag-item"><a class="tag-link" href="/tags/Java/">Java</a></li><li class="tag-item"><a class="tag-link" href="/tags/Jvm/">Jvm</a></li><li class="tag-item"><a class="tag-link" href="/tags/LeetCode/">LeetCode</a></li><li class="tag-item"><a class="tag-link" href="/tags/Mysql/">Mysql</a></li><li class="tag-item"><a class="tag-link" href="/tags/分布式系统/">分布式系统</a></li><li class="tag-item"><a class="tag-link" href="/tags/微服务架构/">微服务架构</a></li><li class="tag-item"><a class="tag-link" href="/tags/数据结构和算法/">数据结构和算法</a></li><li class="tag-item"><a class="tag-link" href="/tags/极客时间/">极客时间</a></li><li class="tag-item"><a class="tag-link" href="/tags/网络协议/">网络协议</a></li><li class="tag-item"><a class="tag-link" href="/tags/设计原则/">设计原则</a></li><li class="tag-item"><a class="tag-link" href="/tags/设计模式/">设计模式</a></li><li class="tag-item"><a class="tag-link" href="/tags/链表/">链表</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">关于</h3><div class="item__content"><p class="item__text">❤这个位置暂时不知道说点什么～先给来到本博客的小朋友一个小心心咯❤</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Shanghai, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2" href="www.baidu.com"></i> <span>16619974352@163.com</span></li><li class="contact-info__item"><i class="iconfont icon-weibo"></i> <span>Nshy-胜楠啊</span></li><li class="contact-info__item"><i class="iconfont icon-github"></i> <span>https://github.com/gaoshengnan</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="/img/avatar.jpg" alt="logo" title="SEINA"></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© Start 2018-11-09 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, made by <a href="https://github.com/gaoshengnan/gaoshengnan.github.io" target="_blank">seina</a>.</p><ul class="footer__social-network clearfix"></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
                processEscapes: true,
                skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            }
            });</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
            var all = MathJax.Hub.getAllJax(), i;
                for (i=0; i < all.length; i += 1) {
                all[i].SourceElement().parentNode.className += ' has-jax';
                }
            });</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>